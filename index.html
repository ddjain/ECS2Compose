<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ECS to Docker Compose Converter</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 0;
    }
    h1 {
      margin-top: 20px;
    }
    .container {
      display: flex;
      width: 90%;
      height: 80vh;
      margin: 20px 0;
      gap: 20px;
    }
    .editor {
      flex: 1;
      height: 100%;
      border: 1px solid #ccc;
      border-radius: 8px;
      overflow: hidden;
    }
    #convertBtn {
      margin: auto 10px;
      padding: 10px 20px;
      height: 50px;
      align-self: center;
      font-size: 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #convertBtn:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>

<h1>ECS JSON to Docker Compose YAML</h1>
<div class="container">
  <div class="editor" id="ecsEditor"></div>
  <button id="convertBtn">â®‚ Convert</button>
  <div class="editor" id="yamlEditor"></div>
</div>

<!-- Load Ace Editor and js-yaml -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.14/ace.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>

<script>
  const ecsEditor = ace.edit("ecsEditor");
  ecsEditor.setTheme("ace/theme/github");
  ecsEditor.session.setMode("ace/mode/json");
  ecsEditor.setValue('{\n  "containerDefinitions": []\n}', -1);

  const yamlEditor = ace.edit("yamlEditor");
  yamlEditor.setTheme("ace/theme/github");
  yamlEditor.session.setMode("ace/mode/yaml");

  function convertEcsToDockerCompose(taskDef) {
    const compose = {
      version: "3",
      services: {},
      volumes: {}
    };

    taskDef.containerDefinitions.forEach(container => {
      const envVars = {};

      // Plain env vars
      container.environment?.forEach(env => {
        envVars[env.name] = env.value;
      });

      // Secrets into env vars
      container.secrets?.forEach(secret => {
        envVars[secret.name] = secret.valueFrom || "REPLACE_WITH_SECRET";
      });

      const service = {
        image: container.image,
        ports: container.portMappings?.map(p => `${p.hostPort || p.containerPort}:${p.containerPort}`),
        environment: envVars,
        volumes: container.mountPoints?.map(mp => `${mp.sourceVolume}:${mp.containerPath}`),
        depends_on: container.dependsOn?.map(d => d.containerName),
      };

      compose.services[container.name] = service;
    });

    taskDef.volumes?.forEach(vol => {
      compose.volumes[vol.name] = {
        driver: "local",
        driver_opts: {
          device: vol.host?.sourcePath || "",
          o: "bind",
          type: "none"
        }
      };
    });

    const yaml = jsyaml.dump(compose, { lineWidth: -1 });
    return { dockerCompose: yaml };
  }

  document.getElementById("convertBtn").addEventListener("click", () => {
    try {
      const ecsJson = JSON.parse(ecsEditor.getValue());
      const { dockerCompose } = convertEcsToDockerCompose(ecsJson);
      yamlEditor.setValue(dockerCompose, -1);
    } catch (err) {
      alert("Invalid JSON or conversion error: " + err.message);
    }
  });
</script>

</body>
</html>
